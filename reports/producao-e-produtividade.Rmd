---
title: "Regressão linear na prática"
output: html_notebook
---

```{r warning=FALSE, echo=FALSE, message=FALSE}
library(tidyverse)
library(broom)
library(modelr)
library(ggplot2)
install.packages("gridExtra")
library("gridExtra")
install.packages("cowplot")
source(here::here("code/lib.R"))
theme_set(theme_bw())

knitr::opts_chunk$set(tidy = FALSE,
                      fig.width = 6,
                      fig.height = 5)

paleta = c("#404E4D",
           "#92DCE5",
           "#938BA1",
           "#2D3142",
           "#F4743B")
```

## Dados da CAPES sobre avaliação da pós-graduação

A CAPES é um órgão do MEC que tem a atribuição de acompanhar a pós-graduação na universidade brasileira. Uma das formas que ela encontrou de fazer isso e pela qual ela é bastante criticada é através de uma avaliação quantitativa a cada x anos (era 3, mudou para 4). 

Usaremos dados da penúltima avaliação da CAPES: 

```{r}
cacc_tudo = read_projectdata()

glimpse(cacc_tudo)
```

### Produção e produtividade de artigos

Uma das maneiras de avaliar a produção dos docentes que a CAPES utiliza é quantificando a produção de artigos pelos docentes. Os artigos são categorizados em extratos ordenados (A1 é o mais alto), e separados entre artigos em conferências e periódicos. Usaremos para esse lab a produção em periódicos avaliados com A1, A2 e B1. 

```{r}
cacc = cacc_tudo %>%
  transmute(
    docentes = `Docentes permanentes`,
    producao = (periodicos_A1 + periodicos_A2 + periodicos_B1),
    produtividade = producao / docentes,
    mestrados = Dissertacoes,
    doutorados = Teses,
    tem_doutorado = tolower(`Tem doutorado`) == "sim",
    mestrados_pprof = mestrados / docentes,
    doutorados_pprof = doutorados / docentes
  )

cacc_md = cacc %>% 
  filter(tem_doutorado)
```

Diferente de medirmos produção (total produzido), é medirmos produtividade (produzido / utilizado). Abaixo focaremos nessa análise. Para isso crie um modelo que investiga como um conjunto de fatores que você julga que são relevantes se relacionam com a produtividade dos programas. Crie um modelo que avalie como _pelo menos 3 fatores_ se relacionam com a produtividade de um programa. Pode reutilizar fatores que já definimos e analizamos para produção. Mas cuidado para não incluir fatores que sejam função linear de outros já incluídos (ex: incluir A, B e um tercero C=A+B)

Produza abaixo o modelo e um texto que comente (i) o modelo, tal como os que fizemos antes, e (ii) as implicações - o que aprendemos sobre como funcionam programas de pós no brasil?.

### EDA

```{r}
skimr::skim(cacc)
```

# Análise da produtividade
Como queremos analisar a produtividade, vamos primeiro analisar quais variáveis do nosso dataset têm uma correlação forte com a variavel produtividade. A baixo é apresentado um gráfico com a relação entre todas as variáveis, com suas respectivas correlações.
```{r message = FALSE}

caac_sem_tem_doutorado = cacc %>% select(-tem_doutorado)
ggcorr(caac_sem_tem_doutorado, label=TRUE , hjust = 0.75, size = 3)
```
 No gráfico acima, é possível perceber que as variáveis que tem uma correlação forte com produtividade são: producao, doutorados_pprof, docentes, doutorados e mestrados. Como é sabido, o valor da produtividade é o valor do quociente entre producao e docentes, assim como o valor de doutorados_pprof corresponde ao quociente entre doutorados (as teses produzidas) e docentes. Deste modo, vamos considerar doutorados, mestrados, docentes e tem_doutorado além da própria produtividade para as conclusões até o final deste documento.
 
No gráfico abaixo, é apresentado a relação entre as variáveis que serão usadas no nosso modelo: doutorados, mestrados e produtividade.

```{r}

p1 <- cacc %>% ggplot(aes(x= produtividade, y = tem_doutorado)) +
  geom_point(size = 2.5)
p2 <- cacc %>% ggplot(aes(x= produtividade, y = mestrados)) +
  geom_point(size = 2.5)
p3 <- cacc %>% ggplot(aes(x= produtividade, y = doutorados)) +
  geom_point(size = 2.5)
p4 <- cacc %>% ggplot(aes(x= produtividade, y = docentes)) +
  geom_point(size = 2.5)

library(cowplot)
ggdraw() +
  draw_plot(p1, 0, .5, .5, .5) +
  draw_plot(p2, 0, 0, .5, .5) +
  draw_plot(p3, .5, 0, .5, .5) +
  draw_plot(p4, .5, .5, .5, .5) 
```

O gráfico acima, mostra que as quatro variáveis analisadas possuem uma relação com produtividade, o que já sabíamos apenas sabendo o valor da correlação entre as variáveis. 
Agora, vamos criar um modelo usando as variáveis usadas no gráfico acima.

```{r}
modelo = lm(produtividade ~ mestrados + doutorados + docentes + tem_doutorado, data = cacc)
tidy(modelo, conf.int = TRUE, conf.level = 0.95)
```
```{r}
glance(modelo)

```


Regressão múltipla foi utilizada para analisar se mestrados, doutorados, tem_doutorado e docentes têm uma associação significativa com produtividade. Os resultados da regressão indicam que um modelo com os 3 preditores no formato produtividade = 1.564815576 -0.003128184.mestrados + 0.017859890.doutorados + 0.009302168.docentes + 1.240205153.tem_doutoradoTRUE explicam 51.66% da variância da variável de resposta (R2 = 0.5166). A variável que tem uma maior relação com produtividade é tem_doutoradoTRUE (b=[0.681553944, 1.798856362], IC com 95%), enquanto as demais variáveis possuem uma relação mais baixa. Aumentar 1 em mestrados, produz uma diminuição de 0.003128184 na produtividade, enquanto aumentar 1 em tem_doutoradoTRUE produz um aumento de 1.240205153 na produtividade.